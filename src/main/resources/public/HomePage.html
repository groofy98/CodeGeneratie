<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="CSS/HomePageCSS.css">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>DankBank</title>
</head>
<body>
<nav>
    <a href="HomePage.html"><img src="Assets/DankBank2.png" alt="Logo, Back to Home"></a>
    <div class="account">
        <button id="LogOff" type="button" name="button">LogOff</button>
        <a id="accountDetails" href="#"></a>
    </div>
    <div class="editLinks">
        <a href="EditAccountsPage.html">Edit accounts</a>
        <a href="UsersOverview.html">Edit users</a>
    </div>
</nav>
<!-- dit is voor het hele kopje betaalrekening of spaarreking -->
<section class="accounts" id="deposit">
    <!-- dit is de header waar "betaalrekening" of iets komt te staan -->
    <p class="header">Current</p>
    <div class="accountContainer" id="savingContainer">

    </div>
</section>
<!-- dit is voor het hele kopje betaalrekening of spaarreking -->
<section class="accounts" id="saving">
    <!-- dit is de header waar "betaalrekening" of iets komt te staan -->
    <p class="header">Saving</p>
    <div class="accountContainer" id="depositContainer">

    </div>
</section>
</body>
</html>
<script type="text/javascript">
    var user;
    //Check if the user is admin or employee and edit the links in the header
    $(document).ready(function () {
       user = GetLoggedInUser();
       if(user.isEmployee === true){
            $('.editLinks').css("display", "inline-block");
       }
       $('#accountDetails').text(user.firstname + " " + user.lastname);
    });

    //Get all account using the given user id
    $(document).ready(function () {
        $.ajax({
            url: 'account/' + user.id,
            type: "GET",
            crossDomain: true,
            headers:{
                "Accept": "application/json",
            },
            contentType: "application/json",
            success: function (data) {
                $.each(data, function (index) {
                    SortAccounts(data[index]);
                });
            },
            error: function (error) {
                console.log(`Error ${error}`);
            },
        });
    });

    //Check if the account is a saving or a deposit account and display them on the homepage
    function SortAccounts(account) {
        if(account.isActive === true) {
            var balance = GetBalance(account.AccountID);
            var name = GetUser(account.accountHolder);
            cleanAccountID = account.AccountID.replace(/(.{4})/g, '$1 ').replace(/(^\s+|\s+$)/, '');
            if (account.accountType == "Current") {
                $("#savingContainer").append(
                    "   <div onclick=\"linkToTransaction('"+account.AccountID+"')\" id='"+account.AccountID+"' class=\"account\">\n" +
                    "        <a class=\"name\" href=\"#\">" + name.username + "</a>\n" +
                    "        <a class=\"number\" href=\"#\">" + cleanAccountID.toUpperCase() + "</a>\n" +
                    "        <a class=\"amount\" href=\"#\">" + balance + "</a>\n" +
                    "    </div>");
            } else {
                $("#depositContainer").append(
                    "    <div onclick=\"linkToTransaction('"+account.AccountID+"')\" id='"+account.AccountID+"' class=\"account\">\n" +
                    "        <a class=\"name\" href=\"#\">" + name.username + "</a>\n" +
                    "        <a class=\"number\" href=\"#\">" + cleanAccountID.toUpperCase() + "</a>\n" +
                    "        <a class=\"amount\" href=\"#\">" + balance + "</a>\n" +
                    "    </div>");
            }
        }
    }

    //Get the balance of a specific user
    function GetBalance(id) {
        var balance = "";
        $.ajax({
            url: 'account/balance/' + id,
            type: "GET",
            async: false,
            contentType: "application/json",
            headers:{
                "Accept": "application/json",
            },
            dataType: "json",
            success: function (data) {
                balance = data.amount;
            },
            error: function (error) {
                balance = "-";
            }
        });
        return balance;
    }

    //Get the logged in user
    function GetLoggedInUser() {
        var user = "";
        $.ajax({
            url: 'users/loggedInUser',
            type: "GET",
            async: false,
            contentType: "application/json",
            dataType: "json",
            success: function (data) {
                user = data;
            },
            error: function (error) {
                user = "-";
            }
        });
        return user;
    }

    //Return a user by his user id
    function GetUser(id) {
        var name = "";
        $.ajax({
            url: 'users/' + id,
            type: "GET",
            async: false,
            contentType: "application/json",
            dataType: "json",
            success: function (data) {
                name = data;
            },
            error: function (error) {
                name = "-";
            }
        });
        return name;
    }

    function LogOff() {
        $.ajax({
            url: 'perform_logout',
            type: "GET",
            async: false,
            contentType: "application/json",
            success: function (data) {
                window.location.replace("Login.html");
            },
            error: function (error) {
                alert("An error has occurred.");
            }
        });
    }

    $('#LogOff').click(function () {
        LogOff();
        return false;
    });


    function linkToTransaction(id){
            sessionStorage.setItem('activeAccount', id);
            window.location.href = "TransactionView.html";
    }

    //   var api_url = 'https://virtserver.swaggerhub.com/codegeneratie/Homework/1.0.0/account/1';
    //     //var key = '5b578yg9yvi8sogirbvegoiufg9v9g579gviuiub8' // not real
    //     $.ajax({
    //         url: api_url,
    //         contentType: "application/json",
    //         dataType: 'json',
    //         success: function (result) {
    //           var result = JSON.parse(result);
    //             alert(result);
    //         }
    //     });
    // });
</script>
