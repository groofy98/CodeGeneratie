<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="CSS/GlobalCSS.css">
    <link rel="stylesheet" href="CSS/TransferCSS.css">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather&display=swap" rel="stylesheet">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <title>DankBank</title>
</head>

<body>
<nav>
    <a href="HomePage.html"><img src="Assets/DankBank2.png" alt="Logo, Back to Home"></a>
    <div class="account">
        <button  id="LogOff" type="button" name="button">LogOff</button>
        <a id="accountDetails" href="#">T.Alberts</a>
    </div>
</nav>
<div id="messages">

</div>
<!-- dit is voor het hele kopje betaalrekening of  spaarreking -->
<section class="container" id="deposit">
    <!-- dit is de header waar "betaalrekening" of iets komt te staan -->
    <p class="header">Account</p>
    <div class="accountContainer" id="accountContainer">
    </div>
</section>
<section class="container" id="saving">
    <p class="header">New Transaction</p>
    <div class="transactionContainer" id="transactionContainer">
        <form action="" id="transferForm">
            <label for="euro">Amount</label><br>
            <input type="number" id="euro" name="euro" placeholder="Amount      € 0," min="0" required>
            <input type="number" id="cent" name="cent" placeholder="00" max="100" min="0">

            <label for="to">Recipient</label>
            <input type="text" id="to" name="to" placeholder="NL02 DANK 0123 4567 89" required>

            <input type="submit" value="Submit">
        </form>
    </div>
</section>
</body>

</html>
<script type="text/javascript">
    function LogOff() {
        $.ajax({
            url: 'perform_logout',
            type: "GET",
            async: false,
            contentType: "application/json",
            success: function (data) {
                window.location.replace("Login.html");
            },
            error: function (error) {
                alert("An error has occurred.");
            }
        });
    }

    $('#LogOff').click(function () {
        LogOff();
        return false;
    });

  $(document).ready(function () {
    console.log("Active account: " + sessionStorage.getItem('activeAccount'));
    getAccount(sessionStorage.getItem('activeAccount'));
    $("#transferForm").submit(function (event) {
      event.preventDefault();
      newTransaction();
    });
    var user = GetLoggedInUser();
    $('#accountDetails').text(user.firstname + " " + user.lastname);
  });

  function newTransaction() {
    let transaction = {};
    let euro = Number($("#euro").val());
    let cent = Number($("#cent").val() / 100);
    let total = euro + cent;
    transaction["amount"] = total;
    transaction["accountFrom"] = sessionStorage.getItem('activeAccount');
    transaction["accountTo"] = $("#to").val();
    transaction["userId"] = 0;
    transaction["transactionType"] = "transfer";
    transaction = JSON.stringify(transaction);
    $.ajax({
      url: "transactions",
      method: "POST",
      contentType: "application/json; charset=utf-8",
      data: transaction,
      success: function (result) {
        alert("Transaction succesfull");
        window.location.href = "TransactionView.html";
      },
      error: function (error) {
        console.log(error);
        showMessage(error.responseJSON.message);
      }
    });
  }

      function GetLoggedInUser() {
        var user = "";
        $.ajax({
            url: 'users/loggedInUser',
            type: "GET",
            async: false,
            contentType: "application/json",
            dataType: "json",
            success: function (data) {
                user = data;
            },
            error: function (error) {
                user = "-";
            }
        });
        return user;
    }

  function getAccount() {
    $.ajax({
      url: "account/" + sessionStorage.getItem('activeAccount') + "/details",
      type: "GET",
      crossDomain: true,
      headers: {
        "Accept": "application/json",
      },
      contentType: "application/json",
      dataType: 'json',
      success: function (data) {
        console.log(data);
        SortAccounts(data);
      },
      error: function (error) {
        console.log(`Error ${error}`);
      },
    });
  }

  function SortAccounts(account) {
    var balance = GetBalance(account.AccountID);
    var name = GetUser(account.AccountHolder);
    $("#accountContainer").append("    <div id=\"2\" class=\"account\">\n" +
      "        <a class=\"name\" href=\"#\">" + name.username + "</a>\n" +
      "        <a class=\"number\" href=\"#\">" + account.AccountID + "</a>\n" +
      "        <a class=\"amount\" href=\"#\"> €" + balance + "</a>\n" +
      "    </div>");
  }

  function GetBalance(id) {
    var balance = "";
    $.ajax({
      url: 'account/balance/' + id,
      type: "GET",
      async: false,
      contentType: "application/json",
      headers: {
        "Accept": "application/json",
      },
      dataType: "json",
      success: function (data) {
        balance = data.amount;
        console.log(data);
      },
      error: function (error) {
        console.log(error);
        balance = "-";
      }
    });
    return balance;
  }

  function GetUser(id) {
    var name = "";
    $.ajax({
      url: 'https://virtserver.swaggerhub.com/codegeneratie/Homework/1.0.0/users/' + id,
      type: "GET",
      async: false,
      contentType: "application/json",
      dataType: "json",
      success: function (data) {
        name = data;
      },
      error: function (error) {
        name = "-";
      }
    });
    return name;
  }

  function showMessage(message){
    $("#messages").append(
      " <div class=\"alert\"> " +
        "<span class=\"closebtn\" onclick=\"this.parentElement.style.display='none';\">&times;</span>" +
        "<strong>Attention!</strong> " + message +
      "</div>"


    );
  }


    //   var api_url = 'https://virtserver.swaggerhub.com/codegeneratie/Homework/1.0.0/account/1';
    //     //var key = '5b578yg9yvi8sogirbvegoiufg9v9g579gviuiub8' // not real
    //     $.ajax({
    //         url: api_url,
    //         contentType: "application/json",
    //         dataType: 'json',
    //         success: function (result) {
    //           var result = JSON.parse(result);
    //             alert(result);
    //         }
    //     });
    // });

</script>
